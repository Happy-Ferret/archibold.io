#########################
# archibold.io (C) 2016 #
#########################

if [ "$(which sudo 2> /dev/null)" = "" ]; then
  bash <(curl -s archibold.io/install/sudo)
fi

source <(curl -s archibold.io/require)
require fakeman

if [ "$(cat ~/.bashrc | grep '# archibold weston')" = "" ]; then
  echo '
# archibold weston
export WLD=/usr
export LD_LIBRARY_PATH=$WLD/lib
export PKG_CONFIG_PATH=$WLD/lib/pkgconfig/:$WLD/share/pkgconfig/
export PATH=$WLD/bin:$PATH
export ACLOCAL_PATH=$WLD/share/aclocal
export ACLOCAL="aclocal -I $ACLOCAL_PATH"
export XDG_RUNTIME_DIR=/tmp/${UID}-runtime-dir
' >> ~/.bashrc
fi

if [ "$WLD" = "" ]; then
  source ~/.bashrc
fi

if ! test -d "${XDG_RUNTIME_DIR}"; then
  mkdir "${XDG_RUNTIME_DIR}"
  chmod 0700 "${XDG_RUNTIME_DIR}"
fi

mkdir -p $WLD/share/aclocal

sudo pacman -Sy --needed --noconfirm base-devel git \
  python2-mako libxml2 libxslt \
  glproto libdrm dri2proto dri3proto presentproto xcb-proto libxcb xextproto inputproto exieext randrproto renderproto xineramaproto

mkdir -p ~/weston

cd ~/weston
if [ ! -d wayland ]; then
  git clone git://anongit.freedesktop.org/wayland/wayland
fi
cd wayland
./autogen.sh --prefix=$WLD --disable-documentation

make
sudo make install
fakeman install wayland

cd ~/weston
if [ ! -d wayland-protocols ]; then
  git clone git://anongit.freedesktop.org/wayland/wayland-protocols
fi
cd wayland-protocols
./autogen.sh --prefix=$WLD

make
sudo make install
fakeman install wayland-protocols

cd ~/weston
if [ ! -d pthread-stubs ]; then
  git clone git://anongit.freedesktop.org/xcb/pthread-stubs
fi
cd pthread-stubs
./autogen.sh --prefix=$WLD

make
sudo make install

cd ~/weston
if [ ! -d x11proto ]; then
  git clone git://anongit.freedesktop.org/xorg/proto/x11proto
fi
cd x11proto
./autogen.sh --prefix=$WLD

make
sudo make install

sudo pacman -Sy --needed --noconfirm \
  xtrans libxdmcp libxcb xcb-util xcb-util-image xcb-util-wm kbproto \
  libx11 libxrender libxext libxinerama libxrandr fixesproto libxfixes libxi \
  libxevie xorg-xinput damageproto libxdamage libxshmfence xf86vidmodeproto

cd ~/weston
if [ ! -d mesa ]; then
  git clone git://anongit.freedesktop.org/mesa/mesa
fi
cd mesa
./autogen.sh --prefix=$WLD \
  --enable-gles2 \
  --with-egl-platforms=x11,wayland,drm \
  --enable-gbm --enable-shared-glapi \
  --with-gallium-drivers=vc4 \
  --without-dri-drivers

make
sudo make install
fakeman install mesa

cd ~/weston
if [ ! -d libinput ]; then
  git clone git://anongit.freedesktop.org/wayland/libinput
fi
cd libinput
./autogen.sh --prefix=$WLD
make
sudo make install

cd ~/weston
if [ ! -d weston ]; then
  git clone git://anongit.freedesktop.org/wayland/weston
fi
cd weston
./autogen.sh --prefix=$WLD \
  --disable-libunwind
make
sudo make install
