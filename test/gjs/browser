#!/usr/bin/env gjs

;(function (Gtk, WebKit2) {'use strict';
  Gtk.init(null);
  const
    WIDTH = +param('width', 1920),
    HEIGHT = +param('height', 1080),
    FULLSCREEN = param('fullscreen', false) !== false,
    window = new Gtk.Window({
      title: 'GJS Unframed Browser',
      type : Gtk.WindowType.TOPLEVEL,
      decorated: false,
      window_position: Gtk.WindowPosition.CENTER
    }),
    webView = new WebKit2.WebView(),
    wvSettings = webView.get_settings(),
    scrollWindow = new Gtk.ScrolledWindow({}),
    vbox = new Gtk.Box({orientation: Gtk.Orientation.VERTICAL}),
    gtkSettings = Gtk.Settings.get_default();
  ;

  window.set_default_size(WIDTH, HEIGHT);

  gtkSettings.gtk_application_prefer_dark_theme = true;
  gtkSettings.gtk_theme_name = 'Adwaita';

  [
    'enable_webgl',
    'enable_webaudio',
    'enable_accelerated_compositing'
  ].forEach(function (key) {
    wvSettings[key] = true;
  });

  webView.load_uri(url(ARGV.filter(url => '-' !== url[0])[0] || 'archibold.io/test/css/'));
  scrollWindow.add(webView);
  vbox.pack_start(scrollWindow, true, true, 0);
  window.connect('show', () => {
    if (FULLSCREEN) window.fullscreen();
    else window.set_resizable(false);
    Gtk.main()
  });
  window.connect('destroy', () => Gtk.main_quit());
  window.connect('delete_event', () => false);
  window.add(vbox);
  window.show_all();

  function url(href) {
    return /^([a-z]{2,}):/.test(href) ? href : ('http://' + href);
  }

  function param(name, value) {
    const re = new RegExp('^--' + name + '(=.*)?$', 'i');
    return ARGV.some(p => re.test(p)) ? RegExp.$1.slice(1) : value;
  }

}(
  imports.gi.Gtk,
  imports.gi.WebKit2
));